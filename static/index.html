<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotesMe</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f0f13">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" href="/static/logo.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

        :root {
            --font: 'Outfit', sans-serif;
            --mono: 'JetBrains Mono', monospace;
            --bg-base: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a26;
            --bg-hover: #22222e;
            --bg-active: #2a2a38;
            --bg-glass: rgba(18,18,26,0.7);
            --bg-glass-hover: rgba(26,26,38,0.8);
            --text-primary: #ededf0;
            --text-secondary: #8888a0;
            --text-tertiary: #55556a;
            --text-ghost: #3a3a4d;
            --border: rgba(255,255,255,0.06);
            --border-subtle: rgba(255,255,255,0.03);
            --border-active: rgba(255,255,255,0.12);
            --accent-1: #6c5ce7;
            --accent-2: #00cec9;
            --accent-grad: linear-gradient(135deg, #6c5ce7, #00cec9);
            --accent-grad-2: linear-gradient(135deg, #fd79a8, #6c5ce7);
            --accent-glow: rgba(108,92,231,0.15);
            --danger: #ff6b6b;
            --danger-glow: rgba(255,107,107,0.15);
            --success: #51cf66;
            --warning: #ffd43b;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 30px rgba(108,92,231,0.15);
            --sidebar-w: 260px;
            --notelist-w: 320px;
            --tr: 0.2s cubic-bezier(.4,0,.2,1);
            --tr-spring: 0.4s cubic-bezier(.175,.885,.32,1.275);
        }
        [data-theme=light] {
            --bg-base: #f0f0f5;
            --bg-surface: #ffffff;
            --bg-elevated: #f8f8fc;
            --bg-hover: #ededf5;
            --bg-active: #e0e0ed;
            --bg-glass: rgba(255,255,255,0.75);
            --bg-glass-hover: rgba(255,255,255,0.9);
            --text-primary: #1a1a2e;
            --text-secondary: #6e6e85;
            --text-tertiary: #a0a0b5;
            --text-ghost: #c0c0d0;
            --border: rgba(0,0,0,0.08);
            --border-subtle: rgba(0,0,0,0.04);
            --border-active: rgba(0,0,0,0.15);
            --accent-glow: rgba(108,92,231,0.08);
            --danger-glow: rgba(255,107,107,0.08);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.12);
            --shadow-glow: 0 0 30px rgba(108,92,231,0.08);
        }
        body{font-family:var(--font);background:var(--bg-base);color:var(--text-primary);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased;letter-spacing:-0.01em}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--text-ghost);border-radius:10px}::-webkit-scrollbar-thumb:hover{background:var(--text-tertiary)}

        /* ═══ SVG ICONS ═══ */
        .i{display:inline-flex;align-items:center;justify-content:center;width:1em;height:1em;flex-shrink:0}
        .i svg{width:100%;height:100%;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

        /* ═══ LOGIN ═══ */
        .login-overlay{position:fixed;inset:0;background:var(--bg-base);display:flex;align-items:center;justify-content:center;z-index:1000}
        .login-overlay::before{content:'';position:absolute;width:600px;height:600px;background:radial-gradient(circle,rgba(108,92,231,0.12),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
        .login-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-xl);padding:48px 44px;width:400px;box-shadow:var(--shadow-lg);position:relative;backdrop-filter:blur(20px);animation:fadeUp .6s var(--tr)}
        @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}
        .login-card .logo{text-align:center;margin-bottom:8px}
        .login-card .logo img{width:200px;height:200px;border-radius:var(--radius-md)}
        .login-card h1{font-size:26px;font-weight:700;text-align:center;letter-spacing:-0.03em}
        .login-card p{color:var(--text-secondary);text-align:center;margin-bottom:32px;font-size:14px;font-weight:400}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text-tertiary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em}
        .form-group input,.form-group select{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:15px;font-family:var(--font);background:var(--bg-elevated);color:var(--text-primary);outline:none;transition:all var(--tr)}
        .form-group input:focus{border-color:var(--accent-1);box-shadow:0 0 0 3px var(--accent-glow)}
        .login-error{color:var(--danger);text-align:center;font-size:13px;margin-top:12px;display:none}

        /* ═══ BUTTONS ═══ */
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 18px;border:none;border-radius:var(--radius-md);font-size:14px;font-weight:600;cursor:pointer;transition:all var(--tr);outline:none;font-family:var(--font)}
        .btn-primary{background:var(--accent-grad);color:#fff;width:100%;padding:13px;font-size:15px;border-radius:var(--radius-md);box-shadow:0 4px 16px rgba(108,92,231,0.3);position:relative;overflow:hidden}
        .btn-primary::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity var(--tr)}
        .btn-primary:hover::after{opacity:1}
        .btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(108,92,231,0.4)}
        .btn-ghost{background:transparent;color:var(--text-secondary);padding:8px 10px;border-radius:var(--radius-sm)}
        .btn-ghost:hover{background:var(--bg-hover);color:var(--text-primary)}
        .btn-danger{background:transparent;color:var(--danger);padding:8px 10px}
        .btn-danger:hover{background:var(--danger-glow);color:var(--danger)}
        .btn-sm{padding:6px 12px;font-size:12px}
        .btn-icon{width:36px;height:36px;padding:0;border-radius:var(--radius-sm);background:transparent;color:var(--text-secondary);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all var(--tr)}
        .btn-icon:hover{background:var(--bg-hover);color:var(--text-primary)}
        .btn-icon .i{font-size:18px}

        /* ═══ LAYOUT ═══ */
        .app-layout{display:flex;height:100vh}

        /* ═══ SIDEBAR ═══ */
        .sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:var(--bg-surface);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:transform .35s cubic-bezier(.4,0,.2,1);z-index:10;position:relative}
        .sidebar::after{content:'';position:absolute;right:0;top:0;bottom:0;width:1px;background:linear-gradient(to bottom,transparent,var(--accent-1),transparent);opacity:0.15;pointer-events:none}
        .sidebar-header{padding:24px 20px 16px;display:flex;align-items:center;justify-content:space-between}
        .sidebar-brand{display:flex;align-items:center;gap:10px}
        .sidebar-brand .brand-icon{width:46px;height:46px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:var(--shadow-sm)}
        .sidebar-brand .brand-icon img{width:100%;height:100%;object-fit:cover}
        .sidebar-brand h2{font-size:18px;font-weight:700;letter-spacing:-0.03em}
        .search-box{margin:0 12px 16px;position:relative}
        .search-box input{width:100%;padding:10px 14px 10px 38px;border:1px solid var(--border);border-radius:var(--radius-md);font-size:13px;font-family:var(--font);background:var(--bg-elevated);color:var(--text-primary);outline:none;transition:all var(--tr)}
        .search-box input:focus{border-color:var(--accent-1);box-shadow:0 0 0 3px var(--accent-glow)}
        .search-box input::placeholder{color:var(--text-ghost)}
        .search-box .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-ghost);font-size:14px}
        .folder-list{flex:1;overflow-y:auto;padding:0 8px 8px}
        .folder-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--radius-sm);cursor:pointer;font-size:13.5px;font-weight:500;color:var(--text-secondary);transition:all var(--tr);user-select:none;position:relative}
        .folder-item:hover{background:var(--bg-hover);color:var(--text-primary)}
        .folder-item.active{background:var(--accent-glow);color:var(--accent-1);font-weight:600}
        .folder-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:60%;background:var(--accent-grad);border-radius:0 4px 4px 0}
        .folder-item .fi{font-size:16px;flex-shrink:0;width:22px;text-align:center;opacity:0.8;display:flex;align-items:center;justify-content:center}
        .folder-item.active .fi{opacity:1}
        .folder-item .fn{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .folder-item .fc{font-size:11px;color:var(--text-ghost);flex-shrink:0;background:var(--bg-elevated);padding:2px 8px;border-radius:10px;font-weight:600;font-variant-numeric:tabular-nums}
        .folder-item.active .fc{background:rgba(108,92,231,0.15);color:var(--accent-1)}
        .folder-item .fa{display:none;gap:2px;flex-shrink:0}
        .folder-item:hover .fa{display:flex}
        .folder-item:hover .fc{display:none}
        .fa button{background:none;border:none;cursor:pointer;color:var(--text-tertiary);padding:2px;border-radius:4px;display:flex;align-items:center;font-size:14px}
        .fa button:hover{color:var(--text-primary);background:var(--bg-active)}
        .sidebar-section{padding:20px 14px 8px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-ghost);display:flex;justify-content:space-between;align-items:center}
        .sidebar-footer{padding:16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .user-info{display:flex;align-items:center;gap:10px}
        .user-avatar{width:32px;height:32px;border-radius:var(--radius-sm);background:var(--accent-grad);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;box-shadow:var(--shadow-sm)}
        .user-name{font-size:13px;font-weight:600;color:var(--text-primary)}
        .user-role{font-size:11px;color:var(--text-tertiary)}
        .folder-item[data-depth="1"]{padding-left:32px}
        .folder-item[data-depth="2"]{padding-left:48px}
        .folder-item[data-depth="3"]{padding-left:64px}

        /* ═══ NOTE LIST ═══ */
        .note-list-panel{width:var(--notelist-w);min-width:var(--notelist-w);border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg-base)}
        .note-list-header{padding:24px 20px 16px;display:flex;align-items:center;justify-content:space-between}
        .note-list-header h3{font-size:18px;font-weight:700;letter-spacing:-0.02em}
        .note-list{flex:1;overflow-y:auto;padding:0 10px 10px}
        .note-card{padding:14px 16px;border-radius:var(--radius-md);cursor:pointer;transition:all var(--tr);margin-bottom:4px;border:1px solid transparent;position:relative}
        .note-card:hover{background:var(--bg-surface);border-color:var(--border)}
        .note-card.active{background:var(--bg-surface);border-color:var(--border-active);box-shadow:var(--shadow-sm),inset 0 0 0 1px var(--border)}
        .note-card.active::before{content:'';position:absolute;left:0;top:10px;bottom:10px;width:3px;background:var(--accent-grad);border-radius:0 4px 4px 0}
        .note-card-title{font-size:14px;font-weight:600;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;letter-spacing:-0.01em}
        .note-card-preview{font-size:12.5px;color:var(--text-tertiary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:6px;line-height:1.4}
        .note-card-meta{font-size:11px;color:var(--text-ghost);font-variant-numeric:tabular-nums;display:flex;align-items:center;gap:6px}
        .note-card-pin{color:var(--warning);font-size:12px;display:flex;align-items:center}
        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-ghost);text-align:center;padding:40px}
        .empty-state .empty-icon{font-size:48px;margin-bottom:16px;opacity:0.3}
        .empty-state p{font-size:14px;margin-bottom:4px;font-weight:500}

        /* ═══ TRASH BAR ═══ */
        .trash-bar{padding:10px 20px;background:var(--danger-glow);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--text-secondary)}

        /* ═══ EDITOR ═══ */
        .editor-panel{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg-base);position:relative}
        .editor-toolbar{padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);gap:8px;background:var(--bg-surface)}
        .editor-toolbar-left{display:flex;align-items:center;gap:8px}
        .editor-toolbar-right{display:flex;align-items:center;gap:4px}
        .format-bar{display:flex;align-items:center;gap:3px;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--bg-surface);flex-wrap:wrap}
        .format-btn{background:none;border:none;cursor:pointer;padding:6px 8px;border-radius:var(--radius-sm);color:var(--text-tertiary);display:flex;align-items:center;justify-content:center;transition:all var(--tr);font-size:14px;min-width:32px;height:32px;font-family:var(--font)}
        .format-btn:hover{background:var(--bg-hover);color:var(--text-primary)}
        .format-btn.active{background:var(--accent-glow);color:var(--accent-1)}
        .format-btn .i{font-size:16px}
        .format-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
        .color-input-wrapper{position:relative;display:flex;align-items:center}
        .color-input-wrapper input[type=color]{position:absolute;opacity:0;width:32px;height:32px;cursor:pointer;top:0;left:0}
        .color-swatch{width:14px;height:14px;border-radius:50%;border:2px solid var(--border-active);pointer-events:none}
        .format-select{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);padding:5px 10px;font-size:12px;font-family:var(--font);cursor:pointer;outline:none;height:32px;font-weight:500}
        .format-select:focus{border-color:var(--accent-1)}
        .editor-title{width:100%;padding:32px 48px 12px;border:none;font-size:32px;font-weight:700;background:transparent;color:var(--text-primary);outline:none;font-family:var(--font);letter-spacing:-0.03em}
        .editor-title::placeholder{color:var(--text-ghost)}
        .editor-content{flex:1;padding:8px 48px 60px;outline:none;font-size:15.5px;line-height:1.8;color:var(--text-primary);overflow-y:auto;min-height:0;font-family:var(--font);word-wrap:break-word;overflow-wrap:break-word;caret-color:var(--accent-1)}
        .editor-content:empty::before{content:"Start writing...";color:var(--text-ghost);pointer-events:none;font-style:italic}
        .editor-content img{max-width:100%;height:auto;border-radius:var(--radius-md);border:1px solid var(--border);margin:16px 0;display:block;cursor:pointer;transition:all var(--tr)}
        .editor-content img:hover{box-shadow:var(--shadow-md);border-color:var(--border-active)}
        .editor-content h1{font-size:28px;font-weight:700;margin:20px 0 8px;letter-spacing:-0.03em}
        .editor-content h2{font-size:22px;font-weight:700;margin:16px 0 6px;letter-spacing:-0.02em}
        .editor-content h3{font-size:18px;font-weight:600;margin:14px 0 4px}
        .editor-content blockquote{border-left:3px solid var(--accent-1);margin:16px 0;padding:12px 20px;color:var(--text-secondary);background:var(--accent-glow);border-radius:0 var(--radius-md) var(--radius-md) 0;font-style:italic}
        .editor-content ul,.editor-content ol{margin:8px 0;padding-left:24px}
        .editor-content li{margin:4px 0}
        .editor-content hr{border:none;border-top:1px solid var(--border);margin:24px 0}
        .editor-content a{color:var(--accent-2);text-decoration:none;border-bottom:1px solid rgba(0,206,201,0.3);transition:border-color var(--tr);cursor:pointer}
        .editor-content a:hover{border-bottom-color:var(--accent-2)}
        .editor-content code{font-family:var(--mono);background:var(--bg-elevated);padding:2px 6px;border-radius:4px;font-size:0.9em;color:var(--accent-2)}
        .checklist-item{display:flex;align-items:flex-start;gap:8px;margin:4px 0;list-style:none}
        .checklist-item input[type=checkbox]{margin-top:4px;cursor:pointer;width:16px;height:16px;accent-color:var(--accent-1)}
        .checklist-item.checked>span{text-decoration:line-through;color:var(--text-ghost)}
        .editor-content ul.checklist{list-style:none;padding-left:4px}

        /* ═══ IMAGE RESIZE ═══ */
        .img-resize-wrapper{position:relative;display:inline-block;max-width:100%;margin:16px 0;line-height:0}
        .img-resize-wrapper img{margin:0;display:block}
        .img-resize-wrapper.selected{outline:2px solid var(--accent-1);outline-offset:3px;border-radius:var(--radius-md)}
        .img-resize-handle{position:absolute;width:12px;height:12px;background:var(--accent-1);border:2px solid var(--bg-base);border-radius:50%;z-index:10;display:none;box-shadow:var(--shadow-sm)}
        .img-resize-wrapper.selected .img-resize-handle{display:block}
        .img-resize-handle.se{bottom:-6px;right:-6px;cursor:se-resize}
        .img-resize-handle.sw{bottom:-6px;left:-6px;cursor:sw-resize}
        .img-resize-handle.e{top:50%;right:-6px;transform:translateY(-50%);cursor:e-resize}
        .img-resize-handle.w{top:50%;left:-6px;transform:translateY(-50%);cursor:w-resize}
        .img-resize-info{position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);background:var(--accent-1);color:#fff;padding:3px 10px;border-radius:var(--radius-sm);font-size:11px;white-space:nowrap;display:none;pointer-events:none;font-weight:600;font-family:var(--mono)}
        .img-resize-wrapper.resizing .img-resize-info{display:block}
        .drop-zone-active .editor-content{background:var(--accent-glow);border:2px dashed var(--accent-1);border-radius:var(--radius-md);margin:4px 44px 36px;padding:4px}
        .editor-status{font-size:12px;color:var(--text-ghost);padding:10px 48px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-family:var(--mono);font-weight:400;background:var(--bg-surface)}

        /* ═══ CONTEXT MENU ═══ */
        .context-menu{position:fixed;background:var(--bg-surface);border:1px solid var(--border-active);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);padding:6px;z-index:1000;min-width:200px;display:none;backdrop-filter:blur(20px);animation:fadeUp .15s ease}
        .context-menu.show{display:block}
        .context-menu-item{display:flex;align-items:center;gap:10px;padding:9px 14px;font-size:13px;color:var(--text-primary);cursor:pointer;border-radius:var(--radius-sm);border:none;background:none;width:100%;text-align:left;font-family:var(--font);font-weight:500;transition:background var(--tr)}
        .context-menu-item:hover{background:var(--bg-hover)}
        .context-menu-item .i{font-size:15px}
        .context-menu-item.danger{color:var(--danger)}
        .context-menu-item.danger:hover{background:var(--danger-glow)}
        .context-menu-sep{height:1px;background:var(--border);margin:4px 8px}

        /* ═══ MODAL ═══ */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:500;backdrop-filter:blur(4px)}
        .modal-overlay.show{display:flex}
        .modal{background:var(--bg-surface);border-radius:var(--radius-xl);padding:32px;width:440px;box-shadow:var(--shadow-lg);border:1px solid var(--border-active);max-height:80vh;overflow-y:auto;animation:fadeUp .2s ease}
        .modal h3{font-size:18px;font-weight:700;margin-bottom:20px;letter-spacing:-0.02em}
        .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:24px}

        /* ═══ ADMIN ═══ */
        .admin-user-row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:8px;background:var(--bg-elevated)}
        .admin-user-row .username{font-weight:600;font-size:14px}
        .admin-user-row .badge{font-size:10px;padding:3px 10px;border-radius:20px;background:var(--accent-glow);color:var(--accent-1);font-weight:700;text-transform:uppercase;letter-spacing:0.05em}

        /* ═══ TOAST ═══ */
        .toast-container{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px}
        .toast{background:var(--bg-surface);color:var(--text-primary);padding:12px 20px;border-radius:var(--radius-md);font-size:13px;font-weight:500;box-shadow:var(--shadow-md);border:1px solid var(--border-active);animation:slideInRight .3s var(--tr);backdrop-filter:blur(10px);display:flex;align-items:center;gap:8px}
        .toast::before{content:'';width:22px;height:22px;background:var(--accent-grad);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

        /* ═══ VERSION LIST ═══ */
        .version-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:6px;background:var(--bg-elevated);cursor:pointer;transition:all var(--tr)}
        .version-item:hover{background:var(--bg-hover);border-color:var(--border-active)}
        .version-item .v-info{display:flex;flex-direction:column;gap:2px}
        .version-item .v-title{font-size:13px;font-weight:600}
        .version-item .v-date{font-size:11px;color:var(--text-tertiary);font-family:var(--mono)}
        .version-item .v-actions{display:flex;gap:4px}

        /* ═══ EXPORT DROPDOWN ═══ */
        .export-dropdown{position:absolute;right:0;top:100%;margin-top:4px;background:var(--bg-surface);border:1px solid var(--border-active);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);padding:6px;z-index:100;min-width:180px;animation:fadeUp .15s ease;display:none}
        .export-dropdown.show{display:block}
        .export-dropdown button{display:flex;align-items:center;gap:10px;padding:9px 14px;font-size:13px;color:var(--text-primary);cursor:pointer;border-radius:var(--radius-sm);border:none;background:none;width:100%;text-align:left;font-family:var(--font);font-weight:500;transition:background var(--tr)}
        .export-dropdown button:hover{background:var(--bg-hover)}
        .export-dropdown button .i{font-size:15px;color:var(--text-tertiary)}

        /* ═══ SIDEBAR OVERLAY ═══ */
        .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9;backdrop-filter:blur(4px)}
        .sidebar-overlay.show{display:block}

        /* ═══ MOBILE ═══ */
        @media(max-width:900px){
            .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);box-shadow:var(--shadow-lg)}
            .sidebar.open{transform:translateX(0)}
            .sidebar-overlay.show{display:block}
            .note-list-panel{width:100%;min-width:0}
            .editor-panel{position:fixed;inset:0;background:var(--bg-base);z-index:5;transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1)}
            .editor-panel.open{transform:translateX(0)}
            .editor-title{padding:24px 20px 8px;font-size:24px}
            .editor-content{padding:8px 20px 60px}
            .editor-status{padding:10px 20px}
            .mobile-back{display:flex!important}
        }
        @media(min-width:901px){.mobile-back{display:none!important}.mobile-menu-btn{display:none!important}}
        .hidden{display:none!important}
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <!-- ═══ LOGIN ═══ -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <div class="logo"><img src="/static/logo.svg" alt="NotesMe"></div>
            <p>Sign in to access your notes</p>
            <form id="loginForm">
                <div class="form-group"><label>Username</label><input type="text" id="loginUser" autocomplete="username" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPass" autocomplete="current-password" required></div>
                <button type="submit" class="btn btn-primary" style="margin-top:12px">Sign in</button>
                <div id="loginError" class="login-error">Invalid credentials</div>
            </form>
        </div>
    </div>

    <!-- ═══ APP ═══ -->
    <div id="app" class="app-layout hidden">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <div class="brand-icon"><img src="/static/logo.svg" alt="NotesMe"></div>
                    <h2>NotesMe</h2>
                </div>
                <div style="display:flex;gap:2px">
                    <button class="btn-icon" id="themeToggle" title="Theme"><span class="i"><svg viewBox="0 0 24 24"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></span></button>
                    <button class="btn-icon" id="adminBtn" title="Users" style="display:none" onclick="showAdminPanel()"><span class="i"><svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></span></button>
                </div>
            </div>
            <div class="search-box">
                <span class="search-icon"><span class="i" style="font-size:15px"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></span></span>
                <input type="text" id="searchInput" placeholder="Search notes...">
            </div>
            <div class="folder-list" id="folderList">
                <div class="folder-item active" data-folder="__all__" onclick="selectFolder('__all__')">
                    <span class="fi"><span class="i"><svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 7H2"/><path d="M10 4l-2 3H2"/></svg></span></span><span class="fn">All notes</span><span class="fc" id="allCount">0</span>
                </div>
                <div class="folder-item" data-folder="__none__" onclick="selectFolder('__none__')">
                    <span class="fi"><span class="i"><svg viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/></svg></span></span><span class="fn">Uncategorized</span><span class="fc" id="noneCount">0</span>
                </div>
                <div class="sidebar-section">Folders<button class="btn-icon" onclick="createFolder()" style="width:24px;height:24px;font-size:14px" title="New folder"><span class="i"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></span></button></div>
                <div id="foldersContainer"></div>
                <div class="sidebar-section" style="margin-top:12px">System</div>
                <div class="folder-item" data-folder="__trash__" onclick="selectFolder('__trash__')">
                    <span class="fi"><span class="i"><svg viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></span></span><span class="fn">Trash</span><span class="fc" id="trashCount">0</span>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div><div class="user-name" id="userName">admin</div><div class="user-role" id="userRole">Administrator</div></div>
                </div>
                <button class="btn-icon" onclick="logout()" title="Log out"><span class="i"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></span></button>
            </div>
        </aside>

        <!-- Note list -->
        <div class="note-list-panel">
            <div class="note-list-header">
                <div style="display:flex;align-items:center;gap:10px">
                    <button class="btn-icon mobile-menu-btn" onclick="toggleSidebar()"><span class="i"><svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span></button>
                    <h3 id="currentFolderName">All notes</h3>
                </div>
                <button class="btn-icon" id="newNoteBtn" onclick="createNote()" title="New note" style="background:var(--accent-glow);color:var(--accent-1)"><span class="i"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></span></button>
            </div>
            <div id="trashBar" class="trash-bar hidden">
                <span>Auto-deleted after 30 days</span>
                <button class="btn btn-danger btn-sm" onclick="emptyTrash()">Empty</button>
            </div>
            <div class="note-list" id="noteList"><div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7z"/><polyline points="14,2 14,8 20,8"/></svg></div><p>No notes</p></div></div>
        </div>

        <!-- Editor -->
        <div class="editor-panel" id="editorPanel">
            <div class="editor-toolbar">
                <div class="editor-toolbar-left">
                    <button class="btn-icon mobile-back" onclick="closeEditor()"><span class="i"><svg viewBox="0 0 24 24"><path d="M19 12H5"/><polyline points="12,19 5,12 12,5"/></svg></span></button>
                    <select id="noteFolderSelect" class="format-select"><option value="">Uncategorized</option></select>
                </div>
                <div class="editor-toolbar-right">
                    <button class="btn-icon" onclick="togglePin()" id="pinBtn" title="Pin" style="opacity:0.4"><span class="i"><svg viewBox="0 0 24 24"><path d="M12 17v5"/><path d="M9 10.76a2 2 0 01-1.11 1.79l-1.78.9A2 2 0 005 15.24V16h14v-.76a2 2 0 00-1.11-1.79l-1.78-.9A2 2 0 0115 10.76V5.88c0-.36.1-.71.28-1.02L16 4H8l.72.86c.18.31.28.66.28 1.02v4.88z"/></svg></span></button>
                    <label class="btn-icon" title="Image" style="cursor:pointer"><span class="i"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg></span><input type="file" id="imageInput" accept="image/*" style="display:none" multiple></label>
                    <div style="position:relative">
                        <button class="btn-icon" onclick="toggleExportMenu()" title="Export"><span class="i"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></span></button>
                        <div class="export-dropdown" id="exportDropdown">
                            <button onclick="exportNote('txt')"><span class="i"><svg viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></span> Texte brut (.txt)</button>
                            <button onclick="exportNote('html')"><span class="i"><svg viewBox="0 0 24 24"><polyline points="16,18 22,12 16,6"/><polyline points="8,6 2,12 8,18"/></svg></span> Document (.html)</button>
                        </div>
                    </div>
                    <button class="btn-icon" onclick="showVersions()" id="versionBtn" title="History"><span class="i"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg></span></button>
                    <button class="btn-icon" onclick="deleteCurrentNote()" title="Delete" style="color:var(--danger)"><span class="i"><svg viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></span></button>
                    <span id="editorToolbarTrash"></span>
                </div>
            </div>
            <div class="format-bar" id="formatBar">
                <select class="format-select" id="blockFormat" onchange="execBlock(this.value);this.selectedIndex=0;">
                    <option value="">Style</option><option value="h1">Heading 1</option><option value="h2">Heading 2</option><option value="h3">Heading 3</option><option value="blockquote">Quote</option>
                </select>
                <div class="format-sep"></div>
                <button class="format-btn" onclick="execCmd('bold')" data-cmd="bold" title="Gras (Ctrl+B)"><b>B</b></button>
                <button class="format-btn" onclick="execCmd('italic')" data-cmd="italic" title="Italique (Ctrl+I)"><i>I</i></button>
                <button class="format-btn" onclick="execCmd('underline')" data-cmd="underline" title="Underline (Ctrl+U)"><u>S</u></button>
                <button class="format-btn" onclick="execCmd('strikeThrough')" data-cmd="strikeThrough" title="Strikethrough"><s>ab</s></button>
                <div class="format-sep"></div>
                <div class="color-input-wrapper" title="Text color"><button class="format-btn"><div class="color-swatch" id="colorSwatch" style="background:var(--text-primary)"></div></button><input type="color" id="textColorPicker" value="#ededf0" onchange="applyColor(this.value)"></div>
                <button class="format-btn" onclick="applyHighlight()" title="Surligner"><span class="i"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></span></button>
                <button class="format-btn" onclick="removeFormat()" title="Effacer format"><span class="i"><svg viewBox="0 0 24 24"><path d="M4 7V4h16v3"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg></span></button>
                <div class="format-sep"></div>
                <button class="format-btn" onclick="execCmd('insertUnorderedList')" data-cmd="insertUnorderedList" title="Liste"><span class="i"><svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></span></button>
                <button class="format-btn" onclick="execCmd('insertOrderedList')" data-cmd="insertOrderedList" title="Liste num."><span class="i"><svg viewBox="0 0 24 24"><line x1="10" y1="6" x2="21" y2="6"/><line x1="10" y1="12" x2="21" y2="12"/><line x1="10" y1="18" x2="21" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></span></button>
                <button class="format-btn" onclick="insertChecklist()" title="Checklist"><span class="i"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></span></button>
                <div class="format-sep"></div>
                <button class="format-btn" onclick="insertLink()" title="Lien (Ctrl+K)"><span class="i"><svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></span></button>
                <button class="format-btn" onclick="insertHR()" title="Separator"><span class="i"><svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg></span></button>
            </div>
            <input type="text" class="editor-title" id="editorTitle" placeholder="Untitled">
            <div class="editor-content" id="editorContent" contenteditable="true"></div>
            <div class="editor-status"><span id="editorWordCount">0 words</span><span id="editorSaveStatus">✓ Saved</span></div>
        </div>
        <div class="editor-panel" id="editorEmpty" style="display:none">
            <div class="empty-state"><div class="empty-icon" style="font-size:64px"><svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.376 3.622a1 1 0 013.002 3.002L7.368 18.635a2 2 0 01-.855.506l-2.872.838.838-2.872a2 2 0 01.506-.855z"/></svg></div><p style="font-size:16px;font-weight:600;margin-bottom:4px">Select a note</p><p style="font-size:13px;color:var(--text-ghost)">or create a new one with <span class="i" style="font-size:14px;vertical-align:middle"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></span></p></div>
        </div>
    </div>

    <!-- Context menu -->
    <div class="context-menu" id="contextMenu">
        <button class="context-menu-item" onclick="contextRename()"><span class="i"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></span>  Rename</button>
        <button class="context-menu-item" onclick="contextCreateSub()"><span class="i"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg></span> Subfolder</button>
        <div class="context-menu-sep"></div>
        <button class="context-menu-item danger" onclick="contextDelete()"><span class="i"><svg viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></span>  Delete</button>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent">
            <h3 id="modalTitle">Title</h3>
            <div id="modalBody"><div class="form-group"><label id="modalLabel">Nom</label><input type="text" id="modalInput"></div></div>
            <div class="modal-actions" id="modalActions">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalConfirm" style="width:auto;padding:10px 24px">OK</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

<script>
// ══════════════════════════════════════════
// STATE
// ══════════════════════════════════════════
let token = localStorage.getItem('notes_token');
let folders=[], notes=[], currentFolder='__all__', currentNote=null, saveTimeout=null, contextTarget=null;
let isAdmin=false, isTrashView=false, folderCounts={};

// ══════════════════════════════════════════
// LUCIDE ICON HELPER
// ══════════════════════════════════════════
const IC={
    pin:'<svg viewBox="0 0 24 24"><path d="M12 17v5"/><path d="M9 10.76a2 2 0 01-1.11 1.79l-1.78.9A2 2 0 005 15.24V16h14v-.76a2 2 0 00-1.11-1.79l-1.78-.9A2 2 0 0115 10.76V5.88c0-.36.1-.71.28-1.02L16 4H8l.72.86c.18.31.28 1.02v4.88z"/>',
    restore:'<svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/><path d="M3 3v5h5"/>',
    trash:'<svg viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>',
    folder:'<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>',
    chevron:'<svg viewBox="0 0 24 24"><polyline points="9,18 15,12 9,6"/>',
    dots:'<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>'
};
function icon(name,size){return '<span class="i"'+(size?' style="font-size:'+size+'"':'')+'>'+(IC[name]||'')+'</svg></span>';}

// ══════════════════════════════════════════
// SANITIZE (DOMPurify)
// ══════════════════════════════════════════
const PURIFY_CONFIG = {
    ALLOWED_TAGS: ['b','i','u','s','em','strong','ul','ol','li','a','img','h1','h2','h3','h4','h5','h6','p','br','div','span','blockquote','pre','code','table','thead','tbody','tr','td','th','hr','input','label','sub','sup'],
    ALLOWED_ATTR: ['href','src','alt','title','width','height','style','class','target','type','checked','data-handle'],
    ALLOW_DATA_ATTR: false,
};
function sanitize(html){
    if(typeof DOMPurify!=='undefined') return DOMPurify.sanitize(html||'', PURIFY_CONFIG);
    return escHtml(html||'');
}

// ══════════════════════════════════════════
// API
// ══════════════════════════════════════════
async function api(path, opts={}) {
    const h = {...opts.headers};
    if (token) h['Authorization']='Bearer '+token;
    if (opts.body && !(opts.body instanceof FormData)) { h['Content-Type']='application/json'; opts.body=JSON.stringify(opts.body); }
    const res = await fetch('/api'+path, {...opts, headers:h});
    if (res.status===401) { logout(); return null; }
    if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e.detail||'Error'); }
    return res.json();
}

// ══════════════════════════════════════════
// AUTH
// ══════════════════════════════════════════
document.getElementById('loginForm').addEventListener('submit', async(e)=>{
    e.preventDefault();
    const errEl=document.getElementById('loginError');
    errEl.style.display='none';
    try {
        const res=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:document.getElementById('loginUser').value,password:document.getElementById('loginPass').value})});
        if(res.status===429){const d=await res.json().catch(()=>({}));errEl.textContent=d.detail||'Too many attempts';errEl.style.display='block';return;}
        const d=await res.json();
        if(d.token){token=d.token;localStorage.setItem('notes_token',token);showApp(d.username,d.is_admin);}
        else{errEl.textContent='Invalid credentials';errEl.style.display='block';}
    }catch{errEl.textContent='Invalid credentials';errEl.style.display='block';}
});
function logout(){token=null;localStorage.removeItem('notes_token');location.reload();}
async function showApp(username,admin){
    document.getElementById('loginOverlay').style.display='none';
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('userName').textContent=username;
    document.getElementById('userAvatar').textContent=username[0].toUpperCase();
    isAdmin=!!admin;
    document.getElementById('userRole').textContent=isAdmin?'Administrator':'User';
    document.getElementById('adminBtn').style.display=isAdmin?'':'none';
    await loadFolders();await loadNotes();await loadStats();showEditorEmpty();
}
async function init(){
    if(token){try{const u=await api('/auth/me');if(u){showApp(u.username,u.is_admin);return;}}catch{}}
    document.getElementById('loginOverlay').style.display='flex';
}

// ══════════════════════════════════════════
// FOLDERS
// ══════════════════════════════════════════
async function loadFolders(){folders=await api('/folders')||[];renderFolders();}
function renderFolders(){
    const c=document.getElementById('foldersContainer');c.innerHTML='';
    const roots=folders.filter(f=>!f.parent_id);
    function rf(folder,depth=0){
        const nc=folderCounts[folder.id]||0;
        const d=document.createElement('div');
        d.className='folder-item'+(currentFolder===folder.id?' active':'');
        d.dataset.folder=folder.id;d.dataset.depth=depth;
        d.onclick=(e)=>{if(!e.target.closest('.fa'))selectFolder(folder.id);};
        d.oncontextmenu=(e)=>{e.preventDefault();showContextMenu(e,folder);};
        const hasSub=folders.some(f=>f.parent_id===folder.id);
        d.innerHTML='<span class="fi">'+icon(hasSub?'chevron':'folder','16px')+'</span><span class="fn">'+escHtml(folder.name)+'</span><span class="fc">'+nc+'</span><div class="fa"><button onclick="event.stopPropagation();showContextMenu(event,folders.find(f=>f.id===\''+folder.id+'\'))" title="Options">'+icon('dots','14px')+'</button></div>';
        c.appendChild(d);
        folders.filter(f=>f.parent_id===folder.id).forEach(ch=>rf(ch,depth+1));
    }
    roots.forEach(f=>rf(f));
}
async function loadStats(){
    const s=await api('/stats');
    if(s){
        document.getElementById('allCount').textContent=s.notes;
        document.getElementById('trashCount').textContent=s.trash;
        document.getElementById('noneCount').textContent=s.unclassified;
        folderCounts=s.folder_counts||{};
        renderFolders();
    }
}
async function createFolder(parentId){
    showModal('New folder','Folder name','','Create',async(name)=>{
        if(name.trim()){await api('/folders',{method:'POST',body:{name:name.trim(),parent_id:parentId||null}});await loadFolders();toast('Folder created');}
    });
}

// ══════════════════════════════════════════
// NOTES
// ══════════════════════════════════════════
async function loadNotes(){
    const search=document.getElementById('searchInput').value.trim();
    let path='/notes';const params=new URLSearchParams();
    isTrashView=currentFolder==='__trash__';
    if(isTrashView)params.set('trash','true');
    else if(search)params.set('search',search);
    else if(currentFolder==='__none__')params.set('folder_id','__none__');
    else if(currentFolder!=='__all__')params.set('folder_id',currentFolder);
    const qs=params.toString();if(qs)path+='?'+qs;
    notes=await api(path)||[];renderNotes();
    document.getElementById('trashBar').classList.toggle('hidden',!isTrashView);
    document.getElementById('newNoteBtn').style.display=isTrashView?'none':'';
}
function renderNotes(){
    const list=document.getElementById('noteList');
    if(!notes.length){list.innerHTML='<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7z"/><polyline points="14,2 14,8 20,8"/></svg></div><p>'+(isTrashView?'Trash is empty':'No notes')+'</p></div>';return;}
    list.innerHTML=notes.map((n,i)=>{
        const preview=(n.preview||'').substring(0,120);
        return '<div class="note-card'+(currentNote&&currentNote.id===n.id?' active':'')+'" onclick="selectNote(\''+n.id+'\')" style="animation:fadeIn .3s ease '+(i*0.03)+'s both">'
            +'<div class="note-card-title">'+escHtml(n.title||'Untitled')+'</div>'
            +'<div class="note-card-preview">'+escHtml(preview||'Note vide')+'</div>'
            +'<div class="note-card-meta">'+(n.pinned?'<span class="note-card-pin">'+icon('pin','12px')+'</span>':'')+'<span>'+formatDate(n.updated_at)+'</span>'+(n.deleted_at?' <span style="color:var(--danger)">· Deleted</span>':'')+'</div></div>';
    }).join('');
}
async function createNote(){
    const fid=currentFolder!=='__all__'&&currentFolder!=='__none__'&&currentFolder!=='__trash__'?currentFolder:null;
    const note=await api('/notes',{method:'POST',body:{title:'Untitled',content:'',folder_id:fid}});
    if(note){await loadNotes();await loadStats();selectNote(note.id);document.getElementById('editorTitle').focus();document.getElementById('editorTitle').select();}
}
async function flushSave(){
    if(saveTimeout){clearTimeout(saveTimeout);saveTimeout=null;await saveNote();}
}
async function selectNote(id){
    await flushSave();
    const note=await api('/notes/'+id);if(!note)return;
    currentNote=note;
    document.getElementById('editorPanel').style.display='flex';
    document.getElementById('editorPanel').classList.add('open');
    document.getElementById('editorEmpty').style.display='none';
    document.getElementById('editorTitle').value=note.title;
    document.getElementById('editorContent').innerHTML=sanitize(note.content||'');
    document.getElementById('pinBtn').style.opacity=note.pinned?1:0.4;
    const isDeleted=!!note.deleted_at;
    document.getElementById('editorContent').contentEditable=!isDeleted;
    document.getElementById('editorTitle').readOnly=isDeleted;
    document.getElementById('formatBar').style.display=isDeleted?'none':'flex';
    document.getElementById('editorToolbarTrash').innerHTML=isDeleted?
        '<button class="btn-icon" onclick="restoreNote()" style="color:var(--success)" title="Restore">'+icon('restore','18px')+'</button>'+
        '<button class="btn-icon" onclick="permanentDelete()" style="color:var(--danger)" title="Delete permanently">'+icon('trash','18px')+'</button>':'';
    updateFolderSelect();
    document.getElementById('noteFolderSelect').value=note.folder_id||'';
    document.getElementById('noteFolderSelect').style.display=isDeleted?'none':'';
    updateWordCount();renderNotes();
    document.querySelectorAll('#editorContent img:not(.img-resize-wrapper img)').forEach(img=>wrapImageForResize(img));
    bindCheckboxes();autoLinkUrls();
}
async function restoreNote(){
    if(!currentNote)return;
    await api('/notes/'+currentNote.id+'/restore',{method:'POST'});
    showEditorEmpty();await loadNotes();await loadStats();toast('Note restored');
}
async function permanentDelete(){
    if(!currentNote||!confirm('Delete permanently?'))return;
    await api('/notes/'+currentNote.id+'?permanent=true',{method:'DELETE'});
    showEditorEmpty();await loadNotes();await loadStats();toast('Permanently deleted');
}
async function emptyTrash(){
    if(!confirm('Empty trash?'))return;
    await api('/trash',{method:'DELETE'});await loadNotes();await loadStats();toast('Trash emptied');
}
function showEditorEmpty(){flushSave();document.getElementById('editorPanel').style.display='none';document.getElementById('editorEmpty').style.display='flex';currentNote=null;}
function closeEditor(){flushSave();document.getElementById('editorPanel').classList.remove('open');currentNote=null;renderNotes();}

async function saveNote(){
    if(!currentNote||currentNote.deleted_at)return;
    try{
        const editor=document.getElementById('editorContent');
        let html=editor.innerHTML;
        html=html.replace(/<span class="img-resize-handle[^"]*"[^>]*><\/span>/g,'');
        html=html.replace(/<span class="img-resize-info"[^>]*>.*?<\/span>/g,'');
        html=html.replace(/<span[^>]*class="img-resize-wrapper[^"]*"[^>]*>([\s\S]*?)<\/span>/g,function(match,inner){
            const m=inner.match(/<img[^>]*>/);return m?m[0]:'';
        });
        document.getElementById('editorSaveStatus').textContent='⟳ Saving...';
        await api('/notes/'+currentNote.id,{method:'PUT',body:{title:document.getElementById('editorTitle').value||'Untitled',content:html}});
        document.getElementById('editorSaveStatus').textContent='✓ Saved';
        refreshList();
    }catch(err){
        document.getElementById('editorSaveStatus').textContent='Error';
        console.error('Save failed:',err);
    }
}
let refreshTimer=null;
function refreshList(){clearTimeout(refreshTimer);refreshTimer=setTimeout(async()=>{await loadNotes();await loadStats();},500);}
function scheduleSave(){if(currentNote&&currentNote.deleted_at)return;document.getElementById('editorSaveStatus').textContent='● Modified';clearTimeout(saveTimeout);saveTimeout=setTimeout(saveNote,800);}
document.getElementById('editorTitle').addEventListener('input',scheduleSave);
document.getElementById('editorContent').addEventListener('input',()=>{scheduleSave();updateWordCount();updateFormatState();});
document.getElementById('noteFolderSelect').addEventListener('change',async()=>{
    if(!currentNote)return;await api('/notes/'+currentNote.id,{method:'PUT',body:{folder_id:document.getElementById('noteFolderSelect').value||null}});
    await loadNotes();await loadStats();toast('Note moved');
});
async function togglePin(){
    if(!currentNote)return;const p=!currentNote.pinned;
    await api('/notes/'+currentNote.id,{method:'PUT',body:{pinned:p}});
    currentNote.pinned=p;document.getElementById('pinBtn').style.opacity=p?1:0.4;
    await loadNotes();toast(p?'Pinned':'Unpinned');
}
async function deleteCurrentNote(){
    if(!currentNote)return;
    if(currentNote.deleted_at){permanentDelete();return;}
    if(!confirm('Move to trash?'))return;
    await api('/notes/'+currentNote.id,{method:'DELETE'});
    showEditorEmpty();await loadNotes();await loadStats();toast('Moved to trash');
}

// ══════════════════════════════════════════
// EXPORT
// ══════════════════════════════════════════
function toggleExportMenu(){
    const dd=document.getElementById('exportDropdown');
    dd.classList.toggle('show');
    if(dd.classList.contains('show')){setTimeout(()=>document.addEventListener('click',closeExportMenu,{once:true}),0);}
}
function closeExportMenu(){document.getElementById('exportDropdown').classList.remove('show');}
function exportNote(format){
    if(!currentNote)return;
    closeExportMenu();
    fetch('/api/notes/'+currentNote.id+'/export?format='+format,{headers:{'Authorization':'Bearer '+token}})
        .then(r=>{if(!r.ok)throw new Error();return r.blob();})
        .then(blob=>{
            const url=URL.createObjectURL(blob);const a=document.createElement('a');
            a.href=url;a.download=(currentNote.title||'note').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'_').substring(0,50)+(format==='html'?'.html':'.txt');
            document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
            toast('Note exported');
        }).catch(()=>toast('Export error'));
}

// ══════════════════════════════════════════
// VERSIONS
// ══════════════════════════════════════════
async function showVersions(){
    if(!currentNote)return;
    try{
        const versions=await api('/notes/'+currentNote.id+'/versions');
        document.getElementById('modalTitle').textContent='Version history';
        if(!versions||!versions.length){
            document.getElementById('modalBody').innerHTML='<p style="color:var(--text-tertiary);text-align:center;padding:20px 0">No versions recorded.<br><span style="font-size:12px">Versions are automatically saved every 5 min.</span></p>';
        } else {
            document.getElementById('modalBody').innerHTML=versions.map(v=>{
                const d=new Date(v.created_at);
                const dateStr=d.toLocaleDateString('en-US',{day:'numeric',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
                return '<div class="version-item" onclick="previewVersion('+v.id+')">'
                    +'<div class="v-info"><span class="v-title">'+escHtml(v.title)+'</span><span class="v-date">'+dateStr+'</span></div>'
                    +'<div class="v-actions"><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();restoreVersionById('+v.id+')" title="Restore">Restore</button></div></div>';
            }).join('');
        }
        document.getElementById('modalActions').innerHTML='<button class="btn btn-ghost" onclick="closeModal()">Close</button>';
        document.getElementById('modalOverlay').classList.add('show');
    }catch(e){toast('Error: '+e.message);}
}
async function previewVersion(vid){
    if(!currentNote)return;
    try{
        const v=await api('/notes/'+currentNote.id+'/versions/'+vid);
        document.getElementById('modalTitle').textContent='Version: '+v.title;
        document.getElementById('modalBody').innerHTML='<div style="max-height:300px;overflow-y:auto;padding:16px;background:var(--bg-elevated);border-radius:var(--radius-md);border:1px solid var(--border);font-size:14px;line-height:1.7">'+sanitize(v.content)+'</div>';
        document.getElementById('modalActions').innerHTML='<button class="btn btn-ghost" onclick="showVersions()">Back</button><button class="btn btn-primary" style="width:auto;padding:10px 24px" onclick="restoreVersionById('+vid+')">Restore this version</button>';
    }catch(e){toast('Error: '+e.message);}
}
async function restoreVersionById(vid){
    if(!currentNote||!confirm('Restore this version? The current version will be saved.'))return;
    try{
        const restored=await api('/notes/'+currentNote.id+'/versions/'+vid+'/restore',{method:'POST'});
        if(restored){
            currentNote=restored;
            document.getElementById('editorTitle').value=restored.title;
            document.getElementById('editorContent').innerHTML=sanitize(restored.content||'');
            updateWordCount();closeModal();toast('Version restored');refreshList();
        }
    }catch(e){toast('Error: '+e.message);}
}

// ══════════════════════════════════════════
// WYSIWYG
// ══════════════════════════════════════════
function execCmd(cmd,val){document.getElementById('editorContent').focus();document.execCommand(cmd,false,val||null);scheduleSave();updateFormatState();}
function execBlock(tag){if(!tag)return;document.getElementById('editorContent').focus();document.execCommand('formatBlock',false,tag);scheduleSave();}
function applyColor(c){document.getElementById('colorSwatch').style.background=c;document.getElementById('editorContent').focus();document.execCommand('foreColor',false,c);scheduleSave();}
function applyHighlight(){document.getElementById('editorContent').focus();document.execCommand('hiliteColor',false,'rgba(108,92,231,0.2)');scheduleSave();}
function removeFormat(){document.getElementById('editorContent').focus();document.execCommand('removeFormat',false,null);scheduleSave();}
function insertHR(){document.getElementById('editorContent').focus();document.execCommand('insertHorizontalRule',false,null);scheduleSave();}
function updateFormatState(){
    ['bold','italic','underline','strikeThrough','insertUnorderedList','insertOrderedList'].forEach(cmd=>{
        const btn=document.querySelector('.format-btn[data-cmd="'+cmd+'"]');
        if(btn)btn.classList.toggle('active',document.queryCommandState(cmd));
    });
}
document.addEventListener('selectionchange',()=>{if(document.activeElement===document.getElementById('editorContent'))updateFormatState();});

// ── Checklist ──
function insertChecklist(){
    document.getElementById('editorContent').focus();
    const html='<ul class="checklist"><li class="checklist-item"><input type="checkbox"><span>Task</span></li></ul><br>';
    document.execCommand('insertHTML',false,html);
    scheduleSave();setTimeout(bindCheckboxes,50);
}
function bindCheckboxes(){
    document.querySelectorAll('#editorContent .checklist-item input[type=checkbox]').forEach(cb=>{
        cb.onchange=function(){this.closest('.checklist-item').classList.toggle('checked',this.checked);scheduleSave();};
        const li=cb.closest('.checklist-item');
        if(cb.checked)li.classList.add('checked');else li.classList.remove('checked');
    });
    document.getElementById('editorContent').removeEventListener('keydown',checklistKeyHandler);
    document.getElementById('editorContent').addEventListener('keydown',checklistKeyHandler);
}
function checklistKeyHandler(e){
    if(e.key==='Enter'){
        const sel=window.getSelection();
        const li=sel.anchorNode?.closest?.('.checklist-item')||sel.anchorNode?.parentElement?.closest?.('.checklist-item');
        if(li){
            e.preventDefault();
            const newLi=document.createElement('li');newLi.className='checklist-item';newLi.innerHTML='<input type="checkbox"><span>&nbsp;</span>';
            li.after(newLi);
            const span=newLi.querySelector('span');const range=document.createRange();range.selectNodeContents(span);range.collapse(false);sel.removeAllRanges();sel.addRange(range);
            setTimeout(bindCheckboxes,10);scheduleSave();
        }
    }
}

// ── Link ──
function insertLink(){
    const sel=window.getSelection();const existing=sel.anchorNode?.parentElement?.closest('a');
    const currentUrl=existing?existing.href:'https://';
    showModal('Insert link','URL',currentUrl,'Insert',async(url)=>{
        if(url.trim()){document.getElementById('editorContent').focus();if(existing)existing.href=url.trim();else document.execCommand('createLink',false,url.trim());scheduleSave();}
    });
}
function autoLinkUrls(){
    const editor=document.getElementById('editorContent');const walker=document.createTreeWalker(editor,NodeFilter.SHOW_TEXT,null);
    const urlRegex=/(https?:\/\/[^\s<>"']+)/g;const nodesToProcess=[];let node;
    while(node=walker.nextNode()){if(node.parentElement.tagName==='A')continue;if(urlRegex.test(node.textContent))nodesToProcess.push(node);urlRegex.lastIndex=0;}
    nodesToProcess.forEach(textNode=>{
        const frag=document.createDocumentFragment();let lastIdx=0;
        textNode.textContent.replace(urlRegex,(match,url,offset)=>{
            if(offset>lastIdx)frag.appendChild(document.createTextNode(textNode.textContent.slice(lastIdx,offset)));
            const a=document.createElement('a');a.href=url;a.textContent=url;a.target='_blank';a.rel='noopener';frag.appendChild(a);lastIdx=offset+match.length;
        });
        if(lastIdx<textNode.textContent.length)frag.appendChild(document.createTextNode(textNode.textContent.slice(lastIdx)));
        textNode.parentNode.replaceChild(frag,textNode);
    });
}
document.getElementById('editorContent').addEventListener('click',(e)=>{if(e.target.tagName==='A'&&(e.ctrlKey||e.metaKey)){e.preventDefault();window.open(e.target.href,'_blank');}});

// ══════════════════════════════════════════
// IMAGES
// ══════════════════════════════════════════
document.getElementById('imageInput').addEventListener('change',async(e)=>{for(const f of e.target.files)await uploadImage(f);e.target.value='';});
const ec=document.getElementById('editorContent');
ec.addEventListener('dragover',(e)=>{e.preventDefault();ec.closest('.editor-panel')?.classList.add('drop-zone-active');});
ec.addEventListener('dragleave',()=>{ec.closest('.editor-panel')?.classList.remove('drop-zone-active');});
ec.addEventListener('drop',async(e)=>{e.preventDefault();ec.closest('.editor-panel')?.classList.remove('drop-zone-active');for(const f of e.dataTransfer.files){if(f.type.startsWith('image/'))await uploadImage(f);}});
ec.addEventListener('paste',async(e)=>{const items=e.clipboardData?.items;if(!items)return;for(const item of items){if(item.type.startsWith('image/')){e.preventDefault();const f=item.getAsFile();if(f)await uploadImage(f);return;}}});
async function uploadImage(file){
    if(!currentNote){toast("Select a note first");return;}
    const form=new FormData();form.append('file',file);
    try{const img=await api('/notes/'+currentNote.id+'/images',{method:'POST',body:form});if(img){ec.focus();document.execCommand('insertHTML',false,'<img src="'+img.url+'" alt="'+escHtml(file.name)+'" /><br>');setTimeout(()=>{document.querySelectorAll('#editorContent img:not(.img-resize-wrapper img)').forEach(i=>wrapImageForResize(i));},50);scheduleSave();toast('Image added');}}catch(err){toast('Error: '+err.message);}
}

// ── Image Resize ──
let activeResizeWrapper=null;
function wrapImageForResize(img){
    if(img.parentElement?.classList?.contains('img-resize-wrapper'))return img.parentElement;
    const w=document.createElement('span');w.className='img-resize-wrapper';w.contentEditable='false';
    w.innerHTML='<span class="img-resize-handle se" data-handle="se"></span><span class="img-resize-handle sw" data-handle="sw"></span><span class="img-resize-handle e" data-handle="e"></span><span class="img-resize-handle w" data-handle="w"></span><span class="img-resize-info"></span>';
    img.parentNode.insertBefore(w,img);w.insertBefore(img,w.firstChild);return w;
}
function selectImage(w){deselectAllImages();w.classList.add('selected');activeResizeWrapper=w;}
function deselectAllImages(){document.querySelectorAll('.img-resize-wrapper.selected').forEach(w=>w.classList.remove('selected'));activeResizeWrapper=null;}
ec.addEventListener('click',(e)=>{
    if(e.target.tagName==='IMG'&&e.target.closest('.editor-content')){e.preventDefault();selectImage(wrapImageForResize(e.target));}
    else if(!e.target.closest('.img-resize-wrapper')&&!e.target.closest('a'))deselectAllImages();
});
document.addEventListener('mousedown',(e)=>{
    const handle=e.target.closest('.img-resize-handle');if(!handle)return;e.preventDefault();
    const wrapper=handle.closest('.img-resize-wrapper'),img=wrapper.querySelector('img');if(!img)return;
    wrapper.classList.add('resizing');const info=wrapper.querySelector('.img-resize-info');
    const startX=e.clientX,startW=img.offsetWidth,startH=img.offsetHeight,ratio=startW/startH,dir=handle.dataset.handle;
    const maxW=ec.offsetWidth-96;
    function onMove(ev){let dx=ev.clientX-startX,newW=startW;if(dir==='se'||dir==='e')newW=startW+dx;else newW=startW-dx;newW=Math.max(60,Math.min(maxW,newW));img.style.width=Math.round(newW)+'px';img.style.height=Math.round(newW/ratio)+'px';info.textContent=Math.round(newW)+' × '+Math.round(newW/ratio);}
    function onUp(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);wrapper.classList.remove('resizing');scheduleSave();}
    document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);
});
document.addEventListener('keydown',(e)=>{
    if(activeResizeWrapper&&(e.key==='Delete'||e.key==='Backspace')&&!e.target.matches('input,textarea')&&document.activeElement!==document.getElementById('editorTitle')){e.preventDefault();activeResizeWrapper.remove();activeResizeWrapper=null;scheduleSave();}
});

// ══════════════════════════════════════════
// FOLDER MANAGEMENT
// ══════════════════════════════════════════
function selectFolder(id){
    currentFolder=id;
    document.querySelectorAll('.folder-item').forEach(el=>el.classList.toggle('active',el.dataset.folder===id));
    const names={'__all__':'All notes','__none__':'Uncategorized','__trash__':'Trash'};
    document.getElementById('currentFolderName').textContent=names[id]||(folders.find(f=>f.id===id)||{}).name||'Notes';
    closeSidebar();loadNotes();showEditorEmpty();
}
function updateFolderSelect(){
    const s=document.getElementById('noteFolderSelect');
    s.innerHTML='<option value="">Uncategorized</option>'+folders.map(f=>'<option value="'+f.id+'">'+escHtml(f.name)+'</option>').join('');
}

// Context menu
function showContextMenu(e,folder){e.preventDefault();e.stopPropagation();contextTarget=folder;const m=document.getElementById('contextMenu');m.classList.add('show');m.style.left=Math.min(e.clientX,innerWidth-220)+'px';m.style.top=Math.min(e.clientY,innerHeight-150)+'px';}
document.addEventListener('click',()=>document.getElementById('contextMenu').classList.remove('show'));
function contextRename(){if(!contextTarget)return;showModal('Rename','New name',contextTarget.name,'Rename',async(n)=>{if(n.trim()){await api('/folders/'+contextTarget.id,{method:'PUT',body:{name:n.trim()}});await loadFolders();toast('Folder renamed');}});}
function contextCreateSub(){if(!contextTarget)return;createFolder(contextTarget.id);}
async function contextDelete(){if(!contextTarget||!confirm('Delete "'+contextTarget.name+'" ?'))return;await api('/folders/'+contextTarget.id,{method:'DELETE'});if(currentFolder===contextTarget.id)selectFolder('__all__');await loadFolders();await loadNotes();await loadStats();toast('Folder deleted');}

// ══════════════════════════════════════════
// ADMIN
// ══════════════════════════════════════════
async function showAdminPanel(){
    const users=await api('/users');if(!users)return;
    document.getElementById('modalTitle').textContent='User management';
    let html=users.map(u=>'<div class="admin-user-row"><div><span class="username">'+escHtml(u.username)+'</span> '+(u.is_admin?'<span class="badge">Admin</span>':'')+'</div>'
        +'<button class="btn btn-danger btn-sm" onclick="deleteUser('+u.id+',\''+escHtml(u.username)+'\')" '+(u.id===1?'disabled style="opacity:0.3"':'')+'>Delete</button></div>').join('');
    html+='<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)"><h4 style="font-size:14px;margin-bottom:14px;font-weight:700">New user</h4>'
        +'<div class="form-group"><label>Username</label><input type="text" id="newUsername"></div>'
        +'<div class="form-group"><label>Password</label><input type="password" id="newPassword"></div>'
        +'<div class="form-group"><label style="display:flex;align-items:center;gap:8px;text-transform:none;letter-spacing:normal;font-size:13px"><input type="checkbox" id="newIsAdmin" style="width:auto">Administrator</label></div>'
        +'<button class="btn btn-primary" onclick="addUser()" style="width:auto;padding:10px 24px">Create</button></div>';
    document.getElementById('modalBody').innerHTML=html;
    document.getElementById('modalActions').innerHTML='<button class="btn btn-ghost" onclick="closeModal()">Close</button>';
    document.getElementById('modalOverlay').classList.add('show');
}
async function addUser(){
    const username=document.getElementById('newUsername').value;const password=document.getElementById('newPassword').value;const isAdm=document.getElementById('newIsAdmin').checked;
    if(!username||!password){toast('Please fill in all fields');return;}
    try{await api('/users',{method:'POST',body:{username,password,is_admin:isAdm}});toast('User created');showAdminPanel();}catch(e){toast('Error: '+e.message);}
}
async function deleteUser(id,name){
    if(!confirm('Delete "'+name+'" ?'))return;
    try{await api('/users/'+id,{method:'DELETE'});toast('User deleted');showAdminPanel();}catch(e){toast('Error: '+e.message);}
}

// ══════════════════════════════════════════
// MODAL
// ══════════════════════════════════════════
function showModal(title,label,value,confirmText,onConfirm){
    document.getElementById('modalTitle').textContent=title;
    document.getElementById('modalBody').innerHTML='<div class="form-group"><label>'+label+'</label><input type="text" id="modalInput" value="'+escHtml(value)+'"></div>';
    document.getElementById('modalActions').innerHTML='<button class="btn btn-ghost" onclick="closeModal()">Cancel</button><button class="btn btn-primary" id="modalConfirm" style="width:auto;padding:10px 24px">'+confirmText+'</button>';
    document.getElementById('modalOverlay').classList.add('show');
    setTimeout(()=>{const i=document.getElementById('modalInput');i.focus();i.select();},100);
    const h=async()=>{await onConfirm(document.getElementById('modalInput').value);closeModal();};
    document.getElementById('modalConfirm').onclick=h;
    document.getElementById('modalInput').onkeydown=(e)=>{if(e.key==='Enter')h();};
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show');}

// ══════════════════════════════════════════
// HELPERS
// ══════════════════════════════════════════
let sT;document.getElementById('searchInput').addEventListener('input',()=>{clearTimeout(sT);sT=setTimeout(loadNotes,300);});
function initTheme(){const s=localStorage.getItem('notes_theme');if(s)document.documentElement.dataset.theme=s;else document.documentElement.dataset.theme='dark';}
document.getElementById('themeToggle').addEventListener('click',()=>{const n=document.documentElement.dataset.theme==='dark'?'light':'dark';document.documentElement.dataset.theme=n;localStorage.setItem('notes_theme',n);});
function toggleSidebar(){const s=document.getElementById('sidebar'),o=document.getElementById('sidebarOverlay');s.classList.toggle('open');o.classList.toggle('show',s.classList.contains('open'));}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show');}
function escHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function formatDate(ds){if(!ds)return'';const d=new Date(ds),diff=Date.now()-d;if(diff<60000)return"Just now";if(diff<3600000)return Math.floor(diff/60000)+' min';if(diff<86400000)return Math.floor(diff/3600000)+'h';return d.toLocaleDateString('en-US',{day:'numeric',month:'short'});}
function updateWordCount(){const t=document.getElementById('editorContent').textContent||'';const w=t.trim()?t.trim().split(/\s+/).length:0;document.getElementById('editorWordCount').textContent=w+' word'+(w!==1?'s':'');}
function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.getElementById('toastContainer').appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(20px)';t.style.transition='all .3s ease';setTimeout(()=>t.remove(),300);},2500);}

// Keyboard shortcuts
document.addEventListener('keydown',(e)=>{
    if((e.ctrlKey||e.metaKey)&&e.key==='n'){e.preventDefault();createNote();}
    if((e.ctrlKey||e.metaKey)&&e.key==='k'&&document.activeElement===document.getElementById('editorContent')){e.preventDefault();insertLink();}
    if(e.key==='Escape'){closeModal();document.getElementById('contextMenu').classList.remove('show');closeExportMenu();}
});
// Save before leaving
window.addEventListener('beforeunload',(e)=>{if(saveTimeout&&currentNote){clearTimeout(saveTimeout);saveTimeout=null;const editor=document.getElementById('editorContent');const xhr=new XMLHttpRequest();xhr.open('PUT','/api/notes/'+currentNote.id,false);xhr.setRequestHeader('Content-Type','application/json');xhr.setRequestHeader('Authorization','Bearer '+token);xhr.send(JSON.stringify({title:document.getElementById('editorTitle').value||'Untitled',content:editor.innerHTML}));}});
document.addEventListener('visibilitychange',()=>{if(document.hidden&&saveTimeout)flushSave();});

// PWA
if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{});}

initTheme();init();
</script>
</body>
</html>
